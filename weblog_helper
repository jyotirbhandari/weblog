#!/bin/bash

VAR=0

while getopts "i:(ip)-h(help)-:" opt
do
    case $opt in
        h ) echo -e "Usage: weblog_helper [option] <ADDRESS>\n"; 
            echo -e "Options:\n\n\t"
            echo -e "\t-i --ip\t\tIP ADDRESS or CIDR ADDRESS\n";
            echo -e "\t-h --help\tusage help\n";
            shift;;
        i ) VAR=$2; shift;; 
    esac
done


IPCALC=$(which ipcalc)
REGEX_IPv4='^([0-9]{1,3}\.){3}[0-9]{1,3}(\/([0-9]|[1-2][0-9]|3[0-2]))?$'
IPCALC_NETWORK=`"$IPCALC" "$VAR" |grep 'Network' |awk '{print $2}'`
IPCALC_ADDRESS=
FILE=./source.txt

while read line
do
    if [[ "$VAR" =~ $REGEX_IPv4 ]] && network=$IPCALC_NETWORK;then
        ip=`echo $line |awk '{print $1}'`
        VAR=`"$IPCALC" "$ip" |grep 'Network' |awk '{print $2}'`
        if [[ "$network" == "$VAR" ]];then
            echo "$line" | grep "$ip"
        fi
     else
         exit 0
    fi
done < "$FILE"


