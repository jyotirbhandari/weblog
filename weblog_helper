#!/bin/bash

regex_ip4='^([0-9]{1,3}\.){3}[0-9]{1,3}(\/([0-9]|[1-2][0-9]|3[0-2]))?$'
# regex_ip_cidr_pattern='[0-9]{1,3}(?:\.[0-9]{1,3}){0,3}/[0-9]+'

# regex_ip4='(?<![0-9])(?:(?:25[0-5]|2[0-4][0-9]|[0-1]?[0-9]{1,2})[.](?:25[0-5]|2[0-4][0-9]|[0-1]?[0-9]{1,2})[.](?:25[0-5]|2[0-4][0-9]|[0-1]?[0-9]{1,2})[.](?:25[0-5]|2[0-4][0-9]|[0-1]?[0-9]{1,2}))(?![0-9])'


#while IFS= read -r LINE;
#do 
#    echo $LINE | grep -qE $regex_ip_cidr_pattern
#done < ./source.txt
[ $# -lt 2 ] && echo "wrong number of args" && exit 1
file=$1
var=$2
ipcalc_network=`ipcalc $var |grep 'Network' |awk '{print $2}'`
while read line
do
    if [[ "$var" =~ $regex_ip4 ]] && network=$ipcalc_network;then
        ip=`echo $line |awk '{print $1}'`
        var=`/usr/local/bin/ipcalc "$ip" |grep 'Network' |awk '{print $2}'`
        if [[ $network == $var ]];then
            echo "$line" | grep "$ip"
        fi
     else
         exit 0
    fi
done < "$file"


